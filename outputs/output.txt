======================================================================
RUNNING ALL MODELS (BGN, KP14, GS21)
======================================================================
Started at: Tue 16 Dec 2025, 07:49AM
Output file: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\output.txt
======================================================================


======================================================================
BGN MODEL - Started at Tue 16 Dec 2025, 07:49AM
======================================================================

======================================================================
PANEL GENERATION
======================================================================
Model: BGN
Identifier: 0
Started at Tue 16 Dec 2025, 07:49AM
======================================================================
started import of vasicek at Tue 16 Dec 2025, 07:49AM
finished import of vasicek at Tue 16 Dec 2025, 07:49AM

Parameters:
  N (firms): 1000
  T (periods): 720
  Burnin: 200
  Characteristics: ['size', 'bm', 'agr', 'roe', 'mom']

----------------------------------------------------------------------
Generating panel for BGN model...
----------------------------------------------------------------------
Creating arrays...
Creating panel...

----------------------------------------------------------------------
Saving panel and arrays to C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_arrays.pkl...
----------------------------------------------------------------------
[OK] Saved successfully

----------------------------------------------------------------------
PANEL SUMMARY
----------------------------------------------------------------------
Model: BGN (identifier=0)
  Shape: (720000, 16)
  Columns: ['month', 'firmid', 'mve', 'xret', 'A_1_taylor', 'A_2_taylor', 'A_1_proj', 'A_2_proj', 'roe', 'bm', 'mom', 'agr', 'f_mu_true', 'f_xi_true', 'rf_stand', 'size']
  Months: 200 to 919
  Unique months: 720
  Firms: 1000
  Characteristics: ['size', 'bm', 'agr', 'roe', 'mom']
  Mean excess return: 0.0103
  Std excess return: 0.3517

======================================================================
GENERATION COMPLETE
======================================================================
Finished at Tue 16 Dec 2025, 07:51AM
Total runtime: 143.1s (2.4 minutes)

Output file: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_arrays.pkl

To compute SDF moments:
  python calculate_moments.py bgn_0

To extract factors:
  python run_fama.py bgn_0
  python run_dkkm.py bgn_0 1000
======================================================================
[Parallel(n_jobs=10)]: Using backend LokyBackend with 10 concurrent workers.
[Parallel(n_jobs=10)]: Done  52 tasks      | elapsed:   34.0s
[Parallel(n_jobs=10)]: Done 100 out of 100 | elapsed:   52.3s finished
[Parallel(n_jobs=10)]: Using backend LokyBackend with 10 concurrent workers.
[Parallel(n_jobs=10)]: Done  52 tasks      | elapsed:   29.5s
[Parallel(n_jobs=10)]: Done 100 out of 100 | elapsed:   41.8s finished
[Parallel(n_jobs=10)]: Using backend LokyBackend with 10 concurrent workers.
[Parallel(n_jobs=10)]: Done  52 tasks      | elapsed:   21.0s
[Parallel(n_jobs=10)]: Done 100 out of 100 | elapsed:   42.9s finished
[Parallel(n_jobs=10)]: Using backend LokyBackend with 10 concurrent workers.
[Parallel(n_jobs=10)]: Done  52 tasks      | elapsed:   39.0s
[Parallel(n_jobs=10)]: Done 100 out of 100 | elapsed:   58.8s finished
[Parallel(n_jobs=10)]: Using backend LokyBackend with 10 concurrent workers.
[Parallel(n_jobs=10)]: Done  52 tasks      | elapsed:   28.0s
[Parallel(n_jobs=10)]: Done 100 out of 100 | elapsed:   39.2s finished
[Parallel(n_jobs=10)]: Using backend LokyBackend with 10 concurrent workers.
[Parallel(n_jobs=10)]: Done  52 out of  59 | elapsed:   17.2s remaining:    2.2s
[Parallel(n_jobs=10)]: Done  59 out of  59 | elapsed:   18.6s finished
======================================================================
SDF CONDITIONAL MOMENTS CALCULATION
======================================================================
Panel ID: bgn_0
Model: bgn
Started at Tue 16 Dec 2025, 07:51AM
======================================================================

Loading arrays from C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_arrays.pkl...
Loaded arrays: N=1000, T=720
started import of vasicek at Tue 16 Dec 2025, 07:51AM
finished import of vasicek at Tue 16 Dec 2025, 07:51AM

----------------------------------------------------------------------
Computing SDF conditional moments...
----------------------------------------------------------------------
Computing moments for months 361 to 919
  Total: 559 months
  Using parallel processing with n_jobs=10
  Processing in 6 chunks of 100 months each
----------------------------------------------------------------------

Chunk 1/6: months 361 to 460 (100 months)
  [OK] Chunk 1 saved to bgn_0_moments_chunk0.pkl

Chunk 2/6: months 461 to 560 (100 months)
  [OK] Chunk 2 saved to bgn_0_moments_chunk1.pkl

Chunk 3/6: months 561 to 660 (100 months)
  [OK] Chunk 3 saved to bgn_0_moments_chunk2.pkl

Chunk 4/6: months 661 to 760 (100 months)
  [OK] Chunk 4 saved to bgn_0_moments_chunk3.pkl

Chunk 5/6: months 761 to 860 (100 months)
  [OK] Chunk 5 saved to bgn_0_moments_chunk4.pkl

Chunk 6/6: months 861 to 919 (59 months)
  [OK] Chunk 6 saved to bgn_0_moments_chunk5.pkl

----------------------------------------------------------------------
[OK] All chunks computed in 274.0s (4.6 minutes)

----------------------------------------------------------------------
Consolidating chunks into final moments dictionary...
----------------------------------------------------------------------
  Loading chunk 1/6...
  Loading chunk 2/6...
  Loading chunk 3/6...
  Loading chunk 4/6...
  Loading chunk 5/6...
  Loading chunk 6/6...
  Sorting moments by month...
[OK] Consolidated 559 months

Saving consolidated moments to C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_moments.pkl...
[OK] Moments saved successfully

Cleaning up temporary chunk files...
  Deleted bgn_0_moments_chunk0.pkl
  Deleted bgn_0_moments_chunk1.pkl
  Deleted bgn_0_moments_chunk2.pkl
  Deleted bgn_0_moments_chunk3.pkl
  Deleted bgn_0_moments_chunk4.pkl
  Deleted bgn_0_moments_chunk5.pkl
[OK] Cleanup complete

======================================================================
COMPUTATION COMPLETE
======================================================================
Finished at Tue 16 Dec 2025, 07:56AM
Total runtime: 322.2s (5.4 minutes)

Output file: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_moments.pkl
  Months: 361 to 919 (559 total)
  Each month contains:
    - rp: (1000,) expected returns vector
    - cond_var: (1000, 1000) conditional variance matrix
    - second_moment: (1000, 1000) second moment matrix
    - second_moment_inv: (1000, 1000) inverse second moment matrix
    - sdf_ret: scalar SDF return
    - max_sr: scalar maximum Sharpe ratio

To load moments:
  import pickle
  with open('C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_moments.pkl', 'rb') as f:
      data = pickle.load(f)
  moments = data['moments']
  # Access specific month:
  rp = moments[361]['rp']
  cond_var = moments[361]['cond_var']
======================================================================

Loading panel from C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_arrays.pkl...
Loaded panel: shape=(720000, 16)

Panel after cleaning:
  Start month: 200, End month: 919
  Total observations: 712761
======================================================================
FAMA-FRENCH & FAMA-MACBETH FACTORS
======================================================================
Model: bgn
Panel ID: bgn_0
Configuration: N=1000, T=720, n_jobs=10
Methods: Fama-French, Fama-MacBeth
Started at Tue 16 Dec 2025, 07:57AM
======================================================================

----------------------------------------------------------------------
Computing Fama-French and Fama-MacBeth factors...
[OK] Fama factors computed in 3.0s at 07:57AM

----------------------------------------------------------------------
Extracting model factors from arrays data...

----------------------------------------------------------------------
Computing portfolio statistics...
  Alpha grids: Fama=[0]
  [OK] Fama stats: 1118 observations
[OK] Portfolio statistics computed in 21.4s

Factor Returns Summary:
  FF returns shape: (720, 6)
  FM returns shape: (720, 6)

[OK] Results saved to: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_fama.pkl
     Dictionary keys: ['ff_returns', 'fm_returns', 'fama_stats', 'model_premia_taylor', 'model_premia_proj', 'model_stats', 'panel_id', 'model', 'chars', 'start', 'end']

     Contents:
       ff_returns: DataFrame (720, 6)
       fm_returns: DataFrame (720, 6)
       fama_stats: DataFrame (1118, 7)
       model_premia_taylor: None
       model_premia_proj: None
       model_stats: None
       panel_id: str = bgn_0
       model: str = bgn
       chars: list (length 5)
       start: int64 = 200
       end: int64 = 919

Total runtime: 29.1s (0.5 minutes)

======================================================================
COMPUTATION COMPLETE
======================================================================
Finished at Tue 16 Dec 2025, 07:57AM

Usage examples:
  import pickle
  with open('C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_fama.pkl', 'rb') as f:
      results = pickle.load(f)
  ff = results['ff_returns']
  fm = results['fm_returns']
======================================================================

Loading panel from C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_arrays.pkl...
Loaded panel: shape=(720000, 16)

Panel after cleaning:
  Start month: 200, End month: 919
  Total observations: 712761
======================================================================
DKKM (RANDOM FOURIER FEATURES) FACTORS
======================================================================
Model: bgn
Panel ID: bgn_0
Configuration: N=1000, T=720, n_jobs=10
Features: 6
Started at Tue 16 Dec 2025, 07:57AM
======================================================================

----------------------------------------------------------------------
Computing DKKM factors...
  Features: 6, Matrices: 1
  Rank standardize: True
  Weight matrix 1/1
[ACCELERATION] Using Numba-accelerated DKKM functions
[OK] DKKM factors computed in 3.4s at 07:57AM

----------------------------------------------------------------------
Computing portfolio statistics...
  Alpha grid: [0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1]
  Include market: True
  [OK] DKKM stats: 3913 observations
[OK] Portfolio statistics computed in 26.2s

Factor Returns Summary:
  DKKM: 1 weight matrices
  Features: 6
  Rank standardize: True

[OK] Results saved to: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_dkkm_6.pkl
     Dictionary keys: ['dkkm_factors', 'dkkm_stats', 'weights', 'nfeatures', 'nmat', 'rank_standardize', 'panel_id', 'model', 'chars', 'start', 'end']

     Contents:
       dkkm_factors: DataFrame (720, 6)
       dkkm_stats: DataFrame (3913, 8)
       weights: ndarray (3, 6)
       nfeatures: int = 6
       nmat: int = 1
       rank_standardize: bool = True
       panel_id: str = bgn_0
       model: str = bgn
       chars: list (length 5)
       start: int64 = 200
       end: int64 = 919

Total runtime: 34.5s (0.6 minutes)

======================================================================
COMPUTATION COMPLETE
======================================================================
Finished at Tue 16 Dec 2025, 07:58AM

Usage examples:
  import pickle
  with open('C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_dkkm_6.pkl', 'rb') as f:
      results = pickle.load(f)
  dkkm = results['dkkm_factors']
======================================================================

Loading panel from C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_arrays.pkl...
Loaded panel: shape=(720000, 16)

Panel after cleaning:
  Start month: 200, End month: 919
  Total observations: 712761
======================================================================
DKKM (RANDOM FOURIER FEATURES) FACTORS
======================================================================
Model: bgn
Panel ID: bgn_0
Configuration: N=1000, T=720, n_jobs=10
Features: 36
Started at Tue 16 Dec 2025, 07:58AM
======================================================================

----------------------------------------------------------------------
Computing DKKM factors...
  Features: 36, Matrices: 1
  Rank standardize: True
  Weight matrix 1/1
[ACCELERATION] Using Numba-accelerated DKKM functions
[OK] DKKM factors computed in 2.6s at 07:58AM

----------------------------------------------------------------------
Computing portfolio statistics...
  Alpha grid: [0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1]
  Include market: True
  [OK] DKKM stats: 3913 observations
[OK] Portfolio statistics computed in 29.4s

Factor Returns Summary:
  DKKM: 1 weight matrices
  Features: 36
  Rank standardize: True

[OK] Results saved to: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_dkkm_36.pkl
     Dictionary keys: ['dkkm_factors', 'dkkm_stats', 'weights', 'nfeatures', 'nmat', 'rank_standardize', 'panel_id', 'model', 'chars', 'start', 'end']

     Contents:
       dkkm_factors: DataFrame (720, 36)
       dkkm_stats: DataFrame (3913, 8)
       weights: ndarray (18, 6)
       nfeatures: int = 36
       nmat: int = 1
       rank_standardize: bool = True
       panel_id: str = bgn_0
       model: str = bgn
       chars: list (length 5)
       start: int64 = 200
       end: int64 = 919

Total runtime: 37.6s (0.6 minutes)

======================================================================
COMPUTATION COMPLETE
======================================================================
Finished at Tue 16 Dec 2025, 07:58AM

Usage examples:
  import pickle
  with open('C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_dkkm_36.pkl', 'rb') as f:
      results = pickle.load(f)
  dkkm = results['dkkm_factors']
======================================================================

Loading panel from C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_arrays.pkl...
Loaded panel: shape=(720000, 16)

Panel after cleaning:
  Start month: 200, End month: 919
  Total observations: 712761
======================================================================
DKKM (RANDOM FOURIER FEATURES) FACTORS
======================================================================
Model: bgn
Panel ID: bgn_0
Configuration: N=1000, T=720, n_jobs=10
Features: 360
Started at Tue 16 Dec 2025, 07:58AM
======================================================================

----------------------------------------------------------------------
Computing DKKM factors...
  Features: 360, Matrices: 1
  Rank standardize: True
  Weight matrix 1/1
[ACCELERATION] Using Numba-accelerated DKKM functions
[OK] DKKM factors computed in 4.6s at 07:59AM

----------------------------------------------------------------------
Computing portfolio statistics...
  Alpha grid: [0, 0.0001, 0.001, 0.01, 0.05, 0.1, 1]
  Include market: True
  [OK] DKKM stats: 3913 observations
[OK] Portfolio statistics computed in 169.1s

Factor Returns Summary:
  DKKM: 1 weight matrices
  Features: 360
  Rank standardize: True

[OK] Results saved to: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_dkkm_360.pkl
     Dictionary keys: ['dkkm_factors', 'dkkm_stats', 'weights', 'nfeatures', 'nmat', 'rank_standardize', 'panel_id', 'model', 'chars', 'start', 'end']

     Contents:
       dkkm_factors: DataFrame (720, 360)
       dkkm_stats: DataFrame (3913, 8)
       weights: ndarray (180, 6)
       nfeatures: int = 360
       nmat: int = 1
       rank_standardize: bool = True
       panel_id: str = bgn_0
       model: str = bgn
       chars: list (length 5)
       start: int64 = 200
       end: int64 = 919

Total runtime: 179.4s (3.0 minutes)

======================================================================
COMPUTATION COMPLETE
======================================================================
Finished at Tue 16 Dec 2025, 08:01AM

Usage examples:
  import pickle
  with open('C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_dkkm_360.pkl', 'rb') as f:
      results = pickle.load(f)
  dkkm = results['dkkm_factors']
======================================================================
======================================================================
NoIPCA - COMPLETE WORKFLOW
======================================================================
Started at Tue 16 Dec 2025, 07:49AM

Configuration:
  Model: bgn
  Panel ID: 0
  Full identifier: bgn_0
  DKKM features: [6, 36, 360]


======================================================================
STEP 1: Generating BGN panel data
======================================================================
Running: C:\Users\kerry\AppData\Local\Programs\Python\Python313\python.exe generate_panel.py bgn 0
Started at 07:49AM
[OK] Completed at 07:51AM (took 145.2s / 2.4min)

======================================================================
STEP 2: Calculating SDF conditional moments (rp, cond_var, etc.)
======================================================================
Running: C:\Users\kerry\AppData\Local\Programs\Python\Python313\python.exe calculate_moments.py bgn_0
Started at 07:51AM
[OK] Completed at 07:57AM (took 324.8s / 5.4min)

======================================================================
STEP 3: Computing Fama-French and Fama-MacBeth factors
======================================================================
Running: C:\Users\kerry\AppData\Local\Programs\Python\Python313\python.exe run_fama.py bgn_0
Started at 07:57AM
[OK] Completed at 07:57AM (took 32.3s / 0.5min)

======================================================================
STEP 4.1: Computing DKKM factors (nfeatures=6)
======================================================================
Running: C:\Users\kerry\AppData\Local\Programs\Python\Python313\python.exe run_dkkm.py bgn_0 6
Started at 07:57AM
[OK] Completed at 07:58AM (took 36.6s / 0.6min)

======================================================================
STEP 4.2: Computing DKKM factors (nfeatures=36)
======================================================================
Running: C:\Users\kerry\AppData\Local\Programs\Python\Python313\python.exe run_dkkm.py bgn_0 36
Started at 07:58AM
[OK] Completed at 07:58AM (took 40.0s / 0.7min)

======================================================================
STEP 4.3: Computing DKKM factors (nfeatures=360)
======================================================================
Running: C:\Users\kerry\AppData\Local\Programs\Python\Python313\python.exe run_dkkm.py bgn_0 360
Started at 07:58AM
[OK] Completed at 08:01AM (took 181.8s / 3.0min)

======================================================================
WORKFLOW COMPLETE
======================================================================
Finished at Tue 16 Dec 2025, 08:01AM

Execution Times:
  1. Generate panel:        145.2s (  2.4min)
  2. Calculate moments:     324.8s (  5.4min)
  3. Fama factors:           32.3s (  0.5min)
  4.1 DKKM (n=   6):         36.6s (  0.6min)
  4.2 DKKM (n=  36):         40.0s (  0.7min)
  4.3 DKKM (n= 360):        181.8s (  3.0min)
  --------------------------------------------------
  Total:                    760.8s ( 12.7min)

Output files created in: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs
  1. Panel data: bgn_0_arrays.pkl
  2. SDF moments: bgn_0_moments.pkl
  3. Fama factors: bgn_0_fama.pkl
  4. DKKM (n=6): bgn_0_dkkm_6.pkl
  5. DKKM (n=36): bgn_0_dkkm_36.pkl
  6. DKKM (n=360): bgn_0_dkkm_360.pkl

To load results:
  import pickle
  with open('C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_fama.pkl', 'rb') as f:
      fama_results = pickle.load(f)
  with open('C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\bgn_0_dkkm_6.pkl', 'rb') as f:
      dkkm_results = pickle.load(f)
======================================================================

======================================================================
BGN MODEL - Completed at Tue 16 Dec 2025, 08:01AM
Total time: 761.4s (12.7min)
Return code: 0
======================================================================


======================================================================
KP14 MODEL - Started at Tue 16 Dec 2025, 08:01AM
======================================================================

======================================================================
PANEL GENERATION
======================================================================
Model: KP14
Identifier: 0
Started at Tue 16 Dec 2025, 08:01AM
======================================================================

Parameters:
  N (firms): 1000
  T (periods): 720
  Burnin: 200
  Characteristics: ['size', 'bm', 'agr', 'roe', 'mom']

----------------------------------------------------------------------
Generating panel for KP14 model...
----------------------------------------------------------------------
Creating arrays...
Creating panel...

----------------------------------------------------------------------
Saving panel and arrays to C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\kp14_0_arrays.pkl...
----------------------------------------------------------------------
[OK] Saved successfully

----------------------------------------------------------------------
PANEL SUMMARY
----------------------------------------------------------------------
Model: KP14 (identifier=0)
  Shape: (720000, 13)
  Columns: ['month', 'firmid', 'mve', 'xret', 'A_1_taylor', 'A_2_taylor', 'A_1_proj', 'A_2_proj', 'roe', 'bm', 'mom', 'agr', 'size']
  Months: 200 to 919
  Unique months: 720
  Firms: 1000
  Characteristics: ['size', 'bm', 'agr', 'roe', 'mom']
  Mean excess return: 0.0073
  Std excess return: 0.0653

======================================================================
GENERATION COMPLETE
======================================================================
Finished at Tue 16 Dec 2025, 08:13AM
Total runtime: 692.5s (11.5 minutes)

Output file: C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\kp14_0_arrays.pkl

To compute SDF moments:
  python calculate_moments.py kp14_0

To extract factors:
  python run_fama.py kp14_0
  python run_dkkm.py kp14_0 1000
======================================================================
======================================================================
SDF CONDITIONAL MOMENTS CALCULATION
======================================================================
Panel ID: kp14_0
Model: kp14
Started at Tue 16 Dec 2025, 08:13AM
======================================================================

Loading arrays from C:\Users\kerry\repos\CodeNew\NoIPCA\outputs\kp14_0_arrays.pkl...
Loaded arrays: N=1000, T=720

----------------------------------------------------------------------
Computing SDF conditional moments...
----------------------------------------------------------------------
Traceback (most recent call last):
  File "C:\Users\kerry\repos\CodeNew\NoIPCA\calculate_moments.py", line 272, in <module>
    main()
    ~~~~^^
  File "C:\Users\kerry\repos\CodeNew\NoIPCA\calculate_moments.py", line 138, in main
    sdf_loop = sdf_module.sdf_compute(N, T + burnin, arr_tuple)
  File "C:\Users\kerry\repos\CodeNew\NoIPCA\utils_kp14\sdf_compute_kp14.py", line 98, in sdf_compute
    part2 = (1 - delta*dt)*np.sum(chi*EtA*K**alpha, axis = 0)
                                          ~^^~~~~~
numpy._core._exceptions._ArrayMemoryError: Unable to allocate 6.32 GiB for an array with shape (921, 921, 1000) and data type float64
======================================================================
NoIPCA - COMPLETE WORKFLOW
======================================================================
Started at Tue 16 Dec 2025, 08:01AM

Configuration:
  Model: kp14
  Panel ID: 0
  Full identifier: kp14_0
  DKKM features: [6, 36, 360]


======================================================================
STEP 1: Generating KP14 panel data
======================================================================
Running: C:\Users\kerry\AppData\Local\Programs\Python\Python313\python.exe generate_panel.py kp14 0
Started at 08:01AM
[OK] Completed at 08:13AM (took 695.0s / 11.6min)

======================================================================
STEP 2: Calculating SDF conditional moments (rp, cond_var, etc.)
======================================================================
Running: C:\Users\kerry\AppData\Local\Programs\Python\Python313\python.exe calculate_moments.py kp14_0
Started at 08:13AM

[ERROR] calculate_moments.py failed with return code 1

======================================================================
KP14 MODEL - Completed at Tue 16 Dec 2025, 08:14AM
Total time: 736.0s (12.3min)
Return code: 1
======================================================================


======================================================================
ALL MODELS COMPLETE
======================================================================
Finished at: Tue 16 Dec 2025, 08:14AM
Total time: 1497.4s (25.0min)

Results:
  BGN: SUCCESS
  KP14: FAILED
======================================================================
